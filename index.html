<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loop Runner ‚Äî playloop.run</title>
  <meta name="description" content="Dash, chain, and climb the leaderboard. A fast, tiny browser action game." />

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">

  <!-- Consent Mode v2 (default denied) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent','default',{
      'ad_storage':'denied','ad_user_data':'denied','ad_personalization':'denied','analytics_storage':'denied'
    });
  </script>

  <!-- AdSense (client id provided). Place ad slot markup in body where desired. -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3857946786580406" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b0b10; --fg:#ffffff; --muted:#9aa0a6; --accent:#6cf; --card:rgba(20,20,28,.82);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); overflow:hidden; }
    body{ font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    /* Layout: game centered, no vertical scroll */
    .page{ display:flex; flex-direction:column; height:100%; }
    header{ display:flex; align-items:center; justify-content:center; padding:8px 10px; gap:10px; }
    main{ flex:1; display:grid; place-items:center; min-height:0; }
    footer{ display:flex; justify-content:center; align-items:center; height:0; }

    /* Canvas wrapper ensures overlay fits exactly */
    #gameWrap{ position:relative; max-width:780px; width:100%; margin:0 auto; }
    #game{ display:block; width:100%; height:auto; background:#0e0e14; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.35); }

    /* Top utility UI (Restart / Share / Daily) */
    #lr-ui{ position:fixed; left:8px; right:8px; bottom:8px; display:flex; gap:8px; justify-content:center; pointer-events:auto; z-index:20; }
    #lr-ui button{ padding:.5rem .75rem; border:0; border-radius:.75rem; box-shadow:0 2px 8px rgba(0,0,0,.2); cursor:pointer; background:#1a1a22; color:#fff; }
    #dailyBanner{ margin-left:auto; font-weight:600; opacity:.85; color:var(--muted); display:flex; align-items:center; }

    /* Overlay (Pause / Game Over) */
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:15; }
    #overlay[hidden]{ display:none; }
    #overlayCard{ pointer-events:auto; min-width:min(85%,520px); max-width:92%; border-radius:16px; padding:16px 18px; background:var(--card); backdrop-filter:saturate(1.2) blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.35); color:#fff; outline:none; }
    #overlayCard h2{ margin:0 0 8px 0; font-size:18px; }
    #overlayRow{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }
    #overlayRow button{ border:0; border-radius:12px; padding:.55rem .9rem; cursor:pointer; background:#1a1a22; color:#fff; }

    /* Ad container: fixed to top, capped size to avoid layout shift and scrolling */
    .ad-bar{ position:fixed; top:0; left:0; right:0; display:flex; justify-content:center; padding:4px 0; z-index:30; background:rgba(0,0,0,.15); backdrop-filter:blur(3px); }
    .ad-box{ max-width:728px; width:100%; max-height:90px; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    .ad-box ins{ max-height:90px !important; }

    /* Prevent accidental scroll bounce on iOS */
    .noscr{ position:fixed; inset:0; overflow:hidden; }

    /* KBD styling */
    kbd{ background:#22252e; border:1px solid #2e3240; border-bottom-width:2px; padding:.1rem .35rem; border-radius:6px; font-weight:700; font-size:.9em; }
  </style>
</head>
<body class="noscr">
  <div class="page">
    <!-- Optional top ad bar (slot markup below). Safe-capped height and fixed to avoid scroll. -->
    <div class="ad-bar" aria-hidden="true">
      <div class="ad-box">
        <!-- Example responsive ad (replace data-ad-slot with your slot id) -->
        <!--
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3857946786580406"
             data-ad-slot="YOUR_SLOT_ID"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
        -->
        <span style="opacity:.6;font-size:12px;color:#bbb;">Ad</span>
      </div>
    </div>

    <header aria-hidden="true"></header>

    <main>
      <div id="gameWrap">
        <canvas id="game" width="640" height="360" aria-label="Loop Runner"></canvas>

        <!-- Overlay (covers canvas only) -->
        <div id="overlay" hidden>
          <div id="overlayCard" role="dialog" aria-modal="true" tabindex="-1">
            <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
              <h2 id="ovTitle">Paused</h2>
              <button id="ovClose">‚úï</button>
            </div>
            <div id="ovBody" style="opacity:.95;">Press <kbd>P</kbd> or <kbd>Esc</kbd> to resume.</div>
            <div id="overlayRow">
              <button id="btnResume">‚ñ∂ Resume</button>
              <button id="btnPlayAgain">‚Üª Play Again</button>
              <button id="btnShare">üì£ Share</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer aria-hidden="true"></footer>

    <!-- Bottom quick UI controls -->
    <div id="lr-ui">
      <button id="restartBtn" aria-label="Restart">‚Üª Restart</button>
      <button id="shareBtn" aria-label="Share score">üì£ Share</button>
      <div id="dailyBanner"></div>
    </div>
  </div>

  <script>
    /* ======================================================
       Loop Runner: Daily seed + Share + Quick Restart
       ====================================================== */
    function getTodayKeyUTC(){
      const d=new Date();
      const y=d.getUTCFullYear();
      const m=String(d.getUTCMonth()+1).padStart(2,'0');
      const day=String(d.getUTCDate()).padStart(2,'0');
      return `${y}${m}${day}`;
    }
    const urlParams=new URLSearchParams(location.search);
    const DAILY=urlParams.get('daily')||getTodayKeyUTC();
    const IS_TODAY=DAILY===getTodayKeyUTC();
    window.DAILY=DAILY; // expose for game systems

    // Seeded RNG (simple LCG). Use rng() instead of Math.random() for Daily mode.
    let _seed=Number(DAILY)%2147483647||1;
    function rng(){ _seed=(_seed*48271)%2147483647; return (_seed-1)/2147483646; }
    window.rng=rng;

    // Daily banner
    const dailyBannerEl=document.getElementById('dailyBanner');
    if(dailyBannerEl){ dailyBannerEl.textContent = IS_TODAY ? `Daily Challenge: ${DAILY}` : `Replaying Daily: ${DAILY}`; }

    // Best tracking per daily
    function saveDailyBest(seconds){ const key=`lr_best_${DAILY}`; const prev=Number(localStorage.getItem(key)||0); if(seconds>prev) localStorage.setItem(key,String(seconds)); }
    function getDailyBest(){ return Number(localStorage.getItem(`lr_best_${DAILY}`)||0); }
    window.saveDailyBest=saveDailyBest; window.getDailyBest=getDailyBest;

    // Sharing
    async function shareScore(seconds){
      const shareUrl=new URL(location.href); shareUrl.searchParams.set('daily',DAILY);
      const text=`I survived ${seconds}s in Loop Runner! #LoopRunner ${IS_TODAY?`#Daily${DAILY}`:`(Daily ${DAILY})`}`;
      if(navigator.share){
        try{ await navigator.share({ title:'Loop Runner', text, url:shareUrl.toString() }); return; }catch(e){}
      }
      const t=`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl.toString())}`;
      window.open(t,'_blank','noopener,noreferrer');
    }
    window.shareScore=shareScore;

    // Quick restart (wire to your game). Expects restartGame or startGame to exist.
    function quickRestart(){
      if(window.restartGame)      window.restartGame({ seed:Number(DAILY) });
      else if(typeof window.startGame==='function') window.startGame({ seed:Number(DAILY) });
      else console.warn('Implement restartGame/startGame and call quickRestart()');
      GAME_STATE='playing'; hideOverlay();
    }
    window.quickRestart=quickRestart;

    // Buttons & keys
    document.getElementById('restartBtn')?.addEventListener('click', quickRestart);
    document.getElementById('shareBtn')?.addEventListener('click', ()=>{
      const seconds=Math.round(window.currentRunSeconds||0); shareScore(seconds);
    });

    // Keyboard: R or Space to restart
    window.addEventListener('keydown',(e)=>{
      if(e.repeat) return;
      if(e.key==='r'||e.key==='R'||e.code==='Space'){ e.preventDefault(); quickRestart(); }
    });

    // Run-end hook (call this from your game loop when a run ends)
    window.onRunEnd=function(secondsSurvived){
      const s=Math.round(secondsSurvived||0); window.currentRunSeconds=s; saveDailyBest(s);
      showOverlay({ title:`Game Over ‚Äî ${s}s`, body:'Nice run! Tap/click ‚ÄúPlay Again‚Äù or press <kbd>Space</kbd>.', mode:'gameover' });
    }
  </script>

  <script>
    /* ======================================================
       Canvas Overlay: Pause + Game Over (wired to canvas)
       ====================================================== */
    const $=(id)=>document.getElementById(id);
    const overlay=$('overlay');
    const overlayCard=$('overlayCard');
    const ovTitle=$('ovTitle');
    const ovBody=$('ovBody');
    const btnResume=$('btnResume');
    const btnPlayAgain=$('btnPlayAgain');
    const btnShare=$('btnShare');
    const ovClose=$('ovClose');
    let GAME_STATE='menu'; // 'playing' | 'paused' | 'gameover' | 'menu'
    let lastRunSeconds=0;

    function showOverlay({ title, body, mode }){
      GAME_STATE=mode; if(ovTitle) ovTitle.textContent=title; if(ovBody) ovBody.innerHTML=body; overlay.hidden=false; overlayCard?.focus?.();
    }
    function hideOverlay(){ overlay.hidden=true; }

    window.pauseGameUI=function(){
      if(GAME_STATE!=='playing') return;
      if(typeof window.pauseGame==='function') window.pauseGame();
      showOverlay({ title:'Paused', body:'Press <kbd>P</kbd> or <kbd>Esc</kbd> to resume.', mode:'paused' });
    }
    window.resumeGameUI=function(){
      if(GAME_STATE!=='paused') return;
      if(typeof window.resumeGame==='function') window.resumeGame();
      GAME_STATE='playing'; hideOverlay();
    }

    btnResume.addEventListener('click', ()=>{
      if(GAME_STATE==='paused') window.resumeGameUI();
      else if(GAME_STATE==='gameover') quickRestart();
    });
    btnPlayAgain.addEventListener('click', quickRestart);
    btnShare.addEventListener('click', ()=> window.shareScore?.(lastRunSeconds));
    ovClose.addEventListener('click', ()=>{ if(GAME_STATE==='paused') window.resumeGameUI(); else hideOverlay(); });

    $('game')?.addEventListener('pointerdown', ()=>{ if(GAME_STATE==='gameover') quickRestart(); });

    window.addEventListener('keydown',(e)=>{
      if(e.repeat) return;
      if(e.key==='p'||e.key==='P'||e.key==='Escape'){
        if(GAME_STATE==='playing'){ e.preventDefault(); window.pauseGameUI(); }
        else if(GAME_STATE==='paused'){ e.preventDefault(); window.resumeGameUI(); }
      }
    });

    // Public method to be called by your game loop when the run actually ends
    window.onRunEnd=function(seconds){
      lastRunSeconds=Math.round(seconds||0);
      saveDailyBest(lastRunSeconds);
      showOverlay({ title:`Game Over ‚Äî ${lastRunSeconds}s`, body:'Nice run! Tap/click ‚ÄúPlay Again‚Äù or press <kbd>Space</kbd>.', mode:'gameover' });
    }

    // Optional: auto-start only if your game core exposes restartGame/startGame
if (window.restartGame || typeof window.startGame === 'function') {
  quickRestart();
} else {
  console.info('[Loop Runner] Waiting for game core. Define window.restartGame(opts) or startGame(opts) before this script runs.');
}
  </script>

  <script>
    /* ======================================================
       No-scroll hardening for touch devices
       ====================================================== */
    function preventScroll(e){ e.preventDefault(); }
    window.addEventListener('touchmove', preventScroll, { passive:false });
    window.addEventListener('wheel', preventScroll, { passive:false });
  </script>
</body>
</html>
