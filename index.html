<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Loop Runner: Dash & Chain (Configurable AdSense + CMP)</title>

  <!-- Consent Mode v2 default (denied until CMP or user toggles) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('consent','default',{
      'ad_storage':'denied',
      'ad_user_data':'denied',
      'ad_personalization':'denied',
      'analytics_storage':'denied'
    });
  </script>

  <style>
    html, body { height: 100%; margin: 0; background:#0b0f14; color:#e6edf3; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #ui { position: fixed; inset: 0; pointer-events: none; }
    .hud { position: absolute; top: 12px; left: 12px; display:flex; gap:12px; align-items:center; }
    .hud .pill { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); padding:6px 10px; border-radius:999px; font-weight:600; letter-spacing:.3px; }
    .hud .combo { transition: transform .1s ease; }
    .center { position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); text-align:center; }
    .btn { pointer-events: all; background:#1a2533; border:1px solid #233146; padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer; display:inline-block; margin: 6px; }
    .btn:hover { filter: brightness(1.1); }
    .hint { opacity:.8; font-size: 14px; margin-top: 8px; }
    canvas { display:block; width:100vw; height:100vh; image-rendering: crisp-edges; }
    .invert { filter: invert(1); }

    /* Ad placements */
    #ad-top-wrapper { position: fixed; top: 0; left: 0; right: 0; z-index: 5; background: #0b0f14; padding: 6px 8px 0; }
    #ad-spacer { height: 80px; } /* reserve space */

    /* Modal + Settings */
    .modal { pointer-events:auto; position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index: 20; }
    .modal.show { display:flex; }
    .sheet { width:min(620px, 92vw); background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .sheet h2 { margin: 0 0 8px 0; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size:14px; }
    tr.highlight { background: rgba(255,255,255,0.06); }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    .select, .input { pointer-events:auto; background:#101823; border:1px solid #233146; color:#e6edf3; padding:10px 12px; border-radius:10px; outline:none; }
    .toolbar { pointer-events:auto; position: fixed; top: 8px; right: 8px; display:flex; gap:8px; z-index: 30; }
  </style>
</head>
<body>
  <!-- Top Ad -->
  <div id="ad-top-wrapper">
    <div id="ad-top"></div>
  </div>
  <div id="ad-spacer"></div>

  <!-- Toolbar -->
  <div class="toolbar">
    <button id="settingsBtn" class="btn" title="AdSense & CMP Settings">‚öôÔ∏è Settings</button>
    <button id="lbBtn" class="btn" title="Leaderboard">üèÜ Leaderboard</button>
  </div>

  <canvas id="game"></canvas>
  <div id="ui">
    <div class="hud">
      <div id="score" class="pill">Score: 0</div>
      <div id="combo" class="pill combo">Combo: 0</div>
      <div id="best" class="pill">Best: 0</div>
      <div id="daily" class="pill">Daily: 0</div>
    </div>
    <div id="overlay" class="center" style="display:none">
      <h1 id="title">Loop Runner</h1>
      <p id="subtitle">Dash through enemies. Click/tap towards where you want to dash.<br/>Chain kills to build combo. Don‚Äôt touch enemies while not dashing.</p>
      <div class="row" style="justify-content:center; margin:8px 0;">
        <button id="start" class="btn">Play</button>
        <button id="dailyBtn" class="btn">Daily Run</button>
      </div>
      <div class="hint">Controls: Click/Tap to dash ‚Ä¢ Space to restart ‚Ä¢ P to pause</div>
      <div style="margin-top:10px; opacity:.85; font-size:13px;">Name: <input id="nameInput" class="input" type="text" placeholder="Your name (for scores)" style="width:220px;" /></div>
    </div>
  </div>

  <!-- Leaderboard modal -->
  <div id="lbModal" class="modal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Leaderboard</h2>
        <button id="lbClose" class="btn" style="padding:8px 12px;">Close</button>
      </div>

      <!-- In-modal Ad -->
      <div id="ad-modal" style="margin: 8px 0;"></div>

      <div class="row" style="margin:8px 0 12px 0; align-items:center;">
        <select id="lbMode" class="select">
          <option value="normal">Normal</option>
          <option value="daily">Daily (today)</option>
        </select>
        <div id="lbInfo" style="opacity:.8; font-size:13px;"></div>
      </div>
      <table id="lbTable">
        <thead><tr><th style="width:56px;">#</th><th>Name</th><th>Score</th><th style="text-align:right;">When</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>AdSense & CMP Settings</h2>
        <button id="settingsClose" class="btn" style="padding:8px 12px;">Close</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1; min-width:260px;">
          <label>AdSense Publisher (ca-pub-...)</label><br/>
          <input id="cfgPub" class="input" placeholder="ca-pub-1234567890123456" style="width:100%;" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>Top Slot ID</label><br/>
          <input id="cfgTopSlot" class="input" placeholder="e.g. 1234567890" style="width:100%;" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>Modal Slot ID</label><br/>
          <input id="cfgModalSlot" class="input" placeholder="e.g. 0987654321" style="width:100%;" />
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <div style="flex:1; min-width:260px;">
          <label>Funding Choices Publisher (pub-...)</label><br/>
          <input id="cfgFC" class="input" placeholder="pub-1234567890123456" style="width:100%;" />
        </div>
        <div style="flex:1; min-width:200px;">
          <label>Ad test mode</label><br/>
          <select id="cfgAdTest" class="select" style="width:100%;">
            <option value="on">on (recommended for dev)</option>
            <option value="off">off (production)</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="cfgSave" class="btn">Save & Initialize</button>
        <button id="cfgClear" class="btn">Clear Config</button>
      </div>
      <p style="opacity:.8; font-size:13px; margin-top:8px;">Notes: Ads require HTTPS hosting and valid AdSense IDs. In the UK/EU you must use a certified CMP (Funding Choices is built-in if you provide <code>pub-...</code>).</p>
    </div>
  </div>

<script>
(() => {
  // --- Simple helpers ---
  const $ = (id) => document.getElementById(id);
  function loadConfig(){
    try { return JSON.parse(localStorage.getItem('lr_ads_cfg')||'{}'); } catch { return {}; }
  }
  function saveConfig(cfg){
    localStorage.setItem('lr_ads_cfg', JSON.stringify(cfg));
  }

  // --- AdSense + CMP setup ---
  async function initAdsAndCmp(){
    const cfg = loadConfig();
    if(!cfg.pub) return;
    // Load AdSense script if not present
    if(!document.querySelector('script[data-adsbygoogle]')){
      const s = document.createElement('script');
      s.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${cfg.pub}`;
      s.setAttribute('crossorigin','anonymous');
      s.setAttribute('async','');
      s.dataset.adsbygoogle = '1';
      document.head.appendChild(s);
      await new Promise(res => { s.onload = res; s.onerror = res; setTimeout(res, 1200); });
    }
    // Inject Funding Choices if provided
    if(cfg.fc && !document.querySelector('script[data-fc]')){
      const sfc = document.createElement('script');
      sfc.src = `https://fundingchoicesmessages.google.com/i/${cfg.fc}?ers=1`;
      sfc.async = true; sfc.dataset.fc = '1';
      document.head.appendChild(sfc);
      // Signal googlefcPresent frame
      function signalFC(){ if(!window.frames['googlefcPresent']){ if(document.body){ const f=document.createElement('iframe'); f.name='googlefcPresent'; f.style='width:0;height:0;border:0;display:none'; document.body.appendChild(f);} else { setTimeout(signalFC,0);} } }
      signalFC();
    }
    // Render or refresh ad units
    renderAd('ad-top', cfg.pub, cfg.topSlot, cfg.adtest);
    renderAd('ad-modal', cfg.pub, cfg.modalSlot, cfg.adtest);
  }

  function renderAd(containerId, pub, slot, adtest){
    const el = $(containerId);
    if(!el) return;
    el.innerHTML = '';
    if(!pub || !slot) { el.innerHTML = '<div style="opacity:.6;font-size:12px;">Ad unit not configured.</div>'; return; }
    const ins = document.createElement('ins');
    ins.className = 'adsbygoogle';
    ins.style.display = 'block';
    ins.style.textAlign = 'center';
    ins.setAttribute('data-ad-client', pub);
    ins.setAttribute('data-ad-slot', slot);
    ins.setAttribute('data-ad-format', 'auto');
    ins.setAttribute('data-full-width-responsive', 'true');
    if(adtest === 'on') ins.setAttribute('data-adtest','on');
    el.appendChild(ins);
    (window.adsbygoogle = window.adsbygoogle || []).push({});
  }

  // --- Settings Modal logic ---
  const settingsModal = $('settingsModal');
  $('settingsBtn').onclick = () => { const c=loadConfig(); $('cfgPub').value=c.pub||''; $('cfgTopSlot').value=c.topSlot||''; $('cfgModalSlot').value=c.modalSlot||''; $('cfgFC').value=c.fc||''; $('cfgAdTest').value=c.adtest||'on'; settingsModal.classList.add('show'); };
  $('settingsClose').onclick = () => settingsModal.classList.remove('show');
  $('cfgClear').onclick = () => { localStorage.removeItem('lr_ads_cfg'); alert('Config cleared.'); location.reload(); };
  $('cfgSave').onclick = async () => {
    const cfg = {
      pub: $('cfgPub').value.trim(),
      topSlot: $('cfgTopSlot').value.trim(),
      modalSlot: $('cfgModalSlot').value.trim(),
      fc: $('cfgFC').value.trim(),
      adtest: $('cfgAdTest').value
    };
    saveConfig(cfg);
    settingsModal.classList.remove('show');
    await initAdsAndCmp();
    alert('Saved. Ads/CMP initialized.');
  };

  // --- Leaderboard modal wiring (open via toolbar button) ---
  $('lbBtn').addEventListener('click', () => showLeaderboard());

  // --- Game (same as earlier playable build) ---
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const ui = {
    score: document.getElementById('score'),
    combo: document.getElementById('combo'),
    best: document.getElementById('best'),
    daily: document.getElementById('daily'),
    overlay: document.getElementById('overlay'),
    start: document.getElementById('start'),
    dailyBtn: document.getElementById('dailyBtn'),
    nameInput: document.getElementById('nameInput'),
  };

  const lb = {
    modal: document.getElementById('lbModal'),
    close: document.getElementById('lbClose'),
    modeSel: document.getElementById('lbMode'),
    info: document.getElementById('lbInfo'),
    table: document.getElementById('lbTable').querySelector('tbody'),
  };

  let W = 0, H = 0, DPR = Math.min(devicePixelRatio || 1, 2);
  function resize() {
    W = Math.floor(window.innerWidth);
    H = Math.floor(window.innerHeight);
    canvas.width = W * DPR; canvas.height = H * DPR; canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
  }
  addEventListener('resize', resize); resize();

  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const dist = (ax, ay, bx, by) => Math.hypot(ax-bx, ay-by);
  const now = () => performance.now();
  const todayKey = () => new Date().toISOString().slice(0,10);

  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}};
  let seededRand = Math.random; let usingSeed = false;
  function setDailySeed() { usingSeed = true; seededRand = mulberry32(hashToInt('looprunner:'+todayKey())); }
  function rnd(a=0,b=1){ return (usingSeed?seededRand():Math.random())*(b-a)+a; }
  function rndi(a,b){ return Math.floor(rnd(a,b+1)); }
  function hashToInt(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619);} return h>>>0; }

  let audio, master;
  function initAudio(){ if(!audio){ audio=new (window.AudioContext||window.webkitAudioContext)(); master=audio.createGain(); master.gain.value=0.08; master.connect(audio.destination);} }
  function beep({freq=440,dur=0.08,type='sine',vol=1}){ if(!audio) return; const o=audio.createOscillator(); const g=audio.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=0; g.gain.linearRampToValueAtTime(vol, audio.currentTime+0.005); g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime+dur); o.connect(g); g.connect(master); o.start(); o.stop(audio.currentTime+dur+0.02); }

  const state = {
    running:false, paused:false, score:0, combo:0, time:0,
    best: Number(localStorage.getItem('lr_best')||0),
    dailyBest: Number(localStorage.getItem('lr_daily')||0),
    lastKillAt:0, slowMoUntil:0, hitStopUntil:0, cameraShake:0,
    spawnTimer:0, spawnInterval:1.1,
    dailyMode:false,
  };
  ui.best.textContent = `Best: ${state.best}`;
  ui.daily.textContent = `Daily: ${state.dailyBest}`;
  ui.nameInput.value = localStorage.getItem('lr_name')||'';

  const player = { x: W/2, y: H/2, r: 10, vx: 0, vy: 0, maxSpeed: 900, friction: 9, dashing: false, dashCooldown: 0, dashWindup: 0 };
  const enemies = []; const particles = [];

  function addParticle(x,y,size=2,life=0.4){ const a=rnd(0,Math.PI*2); const sp=rnd(40,240); particles.push({x,y,vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life, maxLife:life, size}); }
  function spawnEnemy(){ const m=24; const side=rndi(0,3); let x,y; if(side===0){x=rnd(-m,W+m); y=-m;} else if(side===1){x=W+m; y=rnd(-m,H+m);} else if(side===2){x=rnd(-m,W+m); y=H+m;} else {x=-m; y=rnd(-m,H+m);} const r=rnd(10,18); const speed=rnd(40,90)+Math.min(state.time*4,220); const ang=Math.atan2(player.y-y, player.x-x)+rnd(-0.5,0.5); const vx=Math.cos(ang)*speed, vy=Math.sin(ang)*speed; enemies.push({x,y,r,vx,vy,speed}); }

  let pointer = { x: W/2, y: H/2, down:false };
  function screenToWorld(e){ const rect=canvas.getBoundingClientRect(); return { x:(e.clientX-rect.left), y:(e.clientY-rect.top) }; }
  function startDashTowards(px,py){ if(player.dashCooldown>0 || state.hitStopUntil>state.time) return; const dx=px-player.x, dy=py-player.y; const len=Math.hypot(dx,dy)||1; const ux=dx/len, uy=dy/len; player.vx=ux*player.maxSpeed; player.vy=uy*player.maxSpeed; player.dashing=true; player.dashCooldown=0.35; player.dashWindup=0.12; beep({freq:220+Math.min(state.combo*22,660), dur:0.06, type:'triangle', vol:0.6}); for (let i=0;i<10;i++) addParticle(player.x, player.y, 3, 0.25); }

  canvas.addEventListener('pointerdown', (e)=>{ initAudio(); pointer.down=true; const p=screenToWorld(e); pointer.x=p.x; pointer.y=p.y; startDashTowards(pointer.x, pointer.y); });
  canvas.addEventListener('pointermove', (e)=>{ const p=screenToWorld(e); pointer.x=p.x; pointer.y=p.y; });
  canvas.addEventListener('pointerup', ()=>{ pointer.down=false; });
  addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ if(!state.running) startGame(); else if(state.paused) togglePause(); }
    if(e.key.toLowerCase()==='p') togglePause();
    const amt=80; if(e.key.startsWith('Arrow')){ let dx=0,dy=0; if(e.key==='ArrowUp') dy=-amt; else if(e.key==='ArrowDown') dy=amt; else if(e.key==='ArrowLeft') dx=-amt; else if(e.key==='ArrowRight') dx=amt; startDashTowards(player.x+dx, player.y+dy); }
  });

  function loadLB(key){ try { return JSON.parse(localStorage.getItem(key)||'[]'); } catch { return []; } }
  function saveLB(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }
  function submitScore(){ const name = (ui.nameInput.value||localStorage.getItem('lr_name')||'Player').slice(0,20).trim()||'Player'; localStorage.setItem('lr_name', name); const entry = { name, score: state.score|0, when: Date.now(), mode: state.dailyMode? 'daily' : 'normal', day: todayKey() };
    if(state.dailyMode){ const key='lr_lb_daily_'+todayKey(); const arr=loadLB(key); arr.push(entry); arr.sort((a,b)=>b.score-a.score); saveLB(key, arr.slice(0,20)); }
    else { const key='lr_lb_normal'; const arr=loadLB(key); arr.push(entry); arr.sort((a,b)=>b.score-a.score); saveLB(key, arr.slice(0,20)); }
  }
  function showLeaderboard(mode){ lb.modal.classList.add('show'); lb.modeSel.value = mode|| (state.dailyMode?'daily':'normal'); renderLeaderboard(); initAdsAndCmp(); }
  function hideLeaderboard(){ lb.modal.classList.remove('show'); }
  function renderLeaderboard(){ const mode = lb.modeSel.value; const key = mode==='daily' ? ('lr_lb_daily_'+todayKey()) : 'lr_lb_normal'; const arr = loadLB(key); lb.table.innerHTML=''; lb.info.textContent = mode==='daily' ? `Date: ${todayKey()} (today)` : 'All-time local (this device)'; arr.slice(0,10).forEach((e, i)=>{
      const tr = document.createElement('tr'); if(localStorage.getItem('lr_name')===e.name && (e.score|0)===((state.score|0)) && Math.abs(Date.now()-e.when)<2000) tr.classList.add('highlight');
      const when = new Date(e.when).toLocaleString();
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(e.name)}</td><td>${e.score}</td><td style="text-align:right; opacity:.8;">${when}</td>`; lb.table.appendChild(tr);
    }); if(arr.length===0){ const tr=document.createElement('tr'); tr.innerHTML = `<td colspan="4" style="opacity:.7;">No scores yet. Play a run!</td>`; lb.table.appendChild(tr); }
  }
  function escapeHtml(s){ return s.replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;"}[c])); }

  lb.close.addEventListener('click', hideLeaderboard);
  lb.modeSel.addEventListener('change', renderLeaderboard);

  function startGame(daily=false){ state.running=true; state.paused=false; state.time=0; state.score=0; state.combo=0; state.slowMoUntil=0; state.hitStopUntil=0; state.cameraShake=0; state.spawnTimer=0; state.spawnInterval=1.1; enemies.length=0; particles.length=0; player.x=W/2; player.y=H/2; player.vx=0; player.vy=0; player.dashing=false; player.dashCooldown=0; player.dashWindup=0; ui.score.textContent='Score: 0'; ui.combo.textContent='Combo: 0'; state.dailyMode=daily; usingSeed=false; if(daily) setDailySeed(); ui.overlay.style.display='none'; }

  function gameOver(){ state.running=false; state.paused=false; if(state.dailyMode){ state.dailyBest=Math.max(state.dailyBest, state.score|0); localStorage.setItem('lr_daily', state.dailyBest); ui.daily.textContent = `Daily: ${state.dailyBest}`; } else { state.best=Math.max(state.best, state.score|0); localStorage.setItem('lr_best', state.best); ui.best.textContent = `Best: ${state.best}`; }
    submitScore();
    document.getElementById('title').textContent = 'Game Over';
    document.getElementById('subtitle').innerHTML = `Score: <b>${state.score|0}</b> ‚Ä¢ Best: <b>${state.dailyMode?state.dailyBest:state.best}</b>`;
    ui.overlay.style.display='block';
    showLeaderboard(state.dailyMode? 'daily':'normal');
  }

  function togglePause(){ if(!state.running) return; state.paused=!state.paused; document.getElementById('title').textContent = state.paused ? 'Paused' : 'Loop Runner'; document.getElementById('subtitle').textContent = state.paused ? 'Press P to resume or Space to restart.' : 'Dash through enemies. Chain kills to build combo.'; ui.overlay.style.display = state.paused ? 'block' : 'none'; }

  ui.start.addEventListener('click', ()=>{ initAudio(); startGame(false); });
  $('dailyBtn').addEventListener('click', ()=>{ initAudio(); startGame(true); });
  ui.overlay.style.display = 'block';

  let last = now();
  function loop(){ requestAnimationFrame(loop); const t = now(); let dt = (t-last)/1000; last=t; if(!state.running || state.paused){ render(); return; }
    state.time += dt; state.score += dt * 10; if(((state.score|0)%10)===0){ ui.score.textContent = `Score: ${state.score|0}`; }
    update(dt); render(); }

  function update(dt){
    state.spawnTimer -= dt; if(state.spawnTimer <= 0){ spawnEnemy(); state.spawnTimer = state.spawnInterval; }

    if(player.dashWindup>0){ player.dashWindup -= dt; if(player.dashWindup<=0) player.dashing=false; }
    const f = Math.exp(-player.friction * dt); player.vx*=f; player.vy*=f; player.x+=player.vx*dt; player.y+=player.vy*dt; player.x=clamp(player.x,8,W-8); player.y=clamp(player.y,8,H-8); if(player.dashCooldown>0) player.dashCooldown-=dt;

    for(let i=0;i<enemies.length;i++){
      const e=enemies[i]; const ang=Math.atan2(player.y-e.y, player.x-e.x); e.vx=Math.cos(ang)*e.speed; e.vy=Math.sin(ang)*e.speed; e.x+=e.vx*dt; e.y+=e.vy*dt;
      const d = dist(e.x,e.y, player.x,player.y);
      if(d < e.r + player.r){ if(player.dashing){
          enemies.splice(i,1); i--; state.combo+=1; const add = Math.floor(10*Math.pow(1.4, state.combo-1)); state.score += add; ui.combo.textContent = `Combo: ${state.combo}`; ui.score.textContent = `Score: ${state.score|0}`; for(let k=0;k<24;k++) addParticle(e.x,e.y, Math.random()*2+2, Math.random()*0.4+0.2); beep({freq: 440 + Math.min(state.combo*30, 1200), dur:0.07, type:'sawtooth', vol:0.5}); state.hitStopUntil = Math.max(state.hitStopUntil, state.time + 0.08); state.cameraShake = Math.min(state.cameraShake + 6, 18); state.lastKillAt = state.time; if(state.combo % 5 === 0){ state.slowMoUntil = state.time + 0.35; document.body.classList.add('invert'); setTimeout(()=> document.body.classList.remove('invert'), 350); for (let k=0;k<30;k++) addParticle(e.x, e.y, Math.random()*2+3, Math.random()*0.4+0.3); beep({freq: 1800, dur: 0.12, type:'square', vol:0.4}); } state.spawnInterval = Math.max(0.35, state.spawnInterval*0.985);
        } else { gameOver(); break; } }
      if(e.x < -100 || e.x > W+100 || e.y < -100 || e.y > H+100){ enemies.splice(i,1); i--; }
    }

    for(let i=0;i<particles.length;i++){ const p=particles[i]; p.life-=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vx*=0.98; p.vy*=0.98; if(p.life<=0){ particles.splice(i,1); i--; } }
    state.cameraShake *= 0.9;
  }

  function render(){ const shakeX=(Math.random()*2-1)*state.cameraShake; const shakeY=(Math.random()*2-1)*state.cameraShake; ctx.save(); ctx.clearRect(0,0,W,H); ctx.translate(shakeX, shakeY);
    ctx.globalAlpha = 0.12; drawGrid(); ctx.globalAlpha = 1;
    for(const p of particles){ const a=Math.max(0, Math.min(1, p.life/p.maxLife)); ctx.globalAlpha=a; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fillStyle='#8fb3ff'; ctx.fill(); ctx.globalAlpha=1; }
    for(const e of enemies){ ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fillStyle='#ff7a7a'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.stroke(); }
    ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fillStyle= player.dashing ? '#88ffcc' : '#e6edf3'; ctx.shadowColor = player.dashing ? '#88ffcc' : '#0000'; ctx.shadowBlur = player.dashing ? 12 : 0; ctx.fill(); ctx.restore(); }

  function drawGrid(){ const step=40; ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1; ctx.beginPath(); for(let x=(performance.now()/50)%step; x<W; x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,H);} for(let y=(performance.now()/50)%step; y<H; y+=step){ ctx.moveTo(0,y); ctx.lineTo(W,y);} ctx.stroke(); }

  // Kick off
  (function boot(){ initAdsAndCmp(); })();
  loop();

})();</script>
</body>
</html>
