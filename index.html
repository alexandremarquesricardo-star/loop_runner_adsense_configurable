<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loop Runner — playloop.run</title>
  <meta name="description" content="Dash, fire, and climb the worldwide leaderboard. A fast, tiny browser action game." />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">

  <!-- Consent Mode v2 (default denied) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent','default',{'ad_storage':'denied','ad_user_data':'denied','ad_personalization':'denied','analytics_storage':'denied'});
  </script>

  <!-- AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3857946786580406" crossorigin="anonymous"></script>

  <!-- Funding Choices (CMP) -->
  <script async src="https://fundingchoicesmessages.google.com/i/pub-3857946786580406?ers=1"></script>
  <script>
    (function signalGooglefcPresent() {
      if (!window.frames['googlefcPresent']) {
        function add(){const f=document.createElement('iframe');f.style='width:0;height:0;border:0;display:none';f.name='googlefcPresent';document.body.appendChild(f);}
        document.body ? add() : setTimeout(signalGooglefcPresent,0);
      }
    })();
  </script>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { height:100%; margin:0; background:#0b0f14; color:#e6edf3; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial; }
    canvas { display:block; width:100vw; height:100vh; image-rendering: crisp-edges; }
    #ui { position: fixed; inset: 0; pointer-events: none; }
    .hud { position:absolute; left:12px; top: calc(var(--adH, 72px) + 12px); display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .pill { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); padding:6px 10px; border-radius:999px; font-weight:600; letter-spacing:.3px; }
    .center { position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); text-align:center; }
    .hint { opacity:.8; font-size:14px; margin-top:8px; }
    input[type="text"] { pointer-events:auto; background:#101823; border:1px solid #233146; color:#e6edf3; padding:10px 12px; border-radius:10px; outline:none; }

    /* CTA buttons */
    .cta{ position:relative; pointer-events:all; border:1px solid transparent; padding:14px 22px; border-radius:14px; font-weight:800; cursor:pointer; display:inline-flex; align-items:center; gap:10px; letter-spacing:.3px; transition:transform .12s ease, filter .12s ease, box-shadow .12s ease; user-select:none; -webkit-tap-highlight-color:transparent; overflow:hidden; }
    .cta:focus-visible{ outline:2px solid #fff; outline-offset:2px; }
    .cta:hover{ transform:translateY(-1px); filter:brightness(1.03); }
    .cta:active{ transform:translateY(1px) scale(.98); }
    .cta__icon{ font-size:18px; line-height:0; }
    .cta--primary{ background:linear-gradient(135deg,#2c7cf7,#7cfdd6 120%); color:#06101a; box-shadow:0 6px 18px rgba(44,124,247,.35), inset 0 1px 0 rgba(255,255,255,.25); border-color:rgba(124,253,214,.25); }
    .cta--secondary{ background:linear-gradient(135deg,#ff7ab6,#ffd277 120%); color:#1a0b0f; box-shadow:0 6px 18px rgba(255,122,182,.35), inset 0 1px 0 rgba(255,255,255,.25); border-color:rgba(255,210,119,.25); }
    .cta::before{ content:""; position:absolute; inset:-30% -10% auto -30%; height:200%; width:140%; background:linear-gradient(100deg,rgba(255,255,255,0) 0%,rgba(255,255,255,.35) 20%,rgba(255,255,255,0) 40%); transform:translateX(-120%) rotate(-20deg); transition:transform .35s ease; pointer-events:none; }
    .cta:hover::before{ transform:translateX(40%) rotate(-20deg); }
    .cta .ripple{ position:absolute; border-radius:999px; transform:translate(-50%,-50%); background:rgba(255,255,255,.45); mix-blend-mode:soft-light; pointer-events:none; animation:ripple .6s ease-out forwards; }
    @keyframes ripple{ from{width:0;height:0;opacity:.55} to{width:520px;height:520px;opacity:0} }
    .cta .spark{ position:absolute; width:6px; height:6px; border-radius:50%; pointer-events:none; filter:blur(.2px); animation:pop .6s ease-out forwards; }
    @keyframes pop{ 0%{transform:translate(0,0) scale(1);opacity:1} 100%{transform:translate(var(--dx),var(--dy)) scale(.4);opacity:0} }

    /* Mobile Fire button */
    #fireBtn { position: fixed; right: 14px; bottom: 18px; z-index: 6; pointer-events:auto; }
    @media (min-width: 900px) { #fireBtn { display:none; } }

    /* Ads (responsive with caps, centered) */
    #ad-top-wrapper { position: fixed; top:0; left:0; right:0; z-index:5; background:#0b0f14; padding:6px 8px 0; width:100%; display:flex; justify-content:center; }
    #ad-spacer { height: var(--adH, 72px); }
    #ad-top-unit { width:100%; max-width:728px; margin:0 auto; }
    @media (max-width:1024px){ #ad-top-unit { max-width:468px; } }
    @media (max-width:480px) { #ad-top-unit { max-width:320px; } }

    /* Collapse ad UI if blocked */
    .ads-blocked #ad-top-wrapper { display:none; }
    .ads-blocked #ad-spacer { height:0 !important; }

    /* Modal */
    .modal { pointer-events:auto; position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10; }
    .modal.show { display:flex; }
    .sheet { width:min(560px, 92vw); background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size:14px; }
  </style>
</head>
<body>
  <div id="ad-top-wrapper">
    <ins id="ad-top-unit" class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-3857946786580406"
         data-ad-slot="7067398117"
         data-ad-format="auto"
         data-full-width-responsive="false"></ins>
  </div>
  <div id="ad-spacer"></div>

  <canvas id="game"></canvas>

  <div id="ui">
    <div class="hud">
      <div id="score" class="pill">Score: 0</div>
      <div id="combo" class="pill">Combo: 0</div>
      <div id="best" class="pill">Best: 0</div>
      <div id="daily" class="pill">Daily: 0</div>
      <a href="privacy.html" class="pill" style="text-decoration:none; pointer-events:auto;">Privacy</a>
      <button id="lbBtn" class="cta cta--secondary" style="pointer-events:auto;">Leaderboard</button>
    </div>

    <div id="overlay" class="center" style="display:none">
      <h1>Loop Runner</h1>
      <p>Dash through enemies. Click/tap to dash toward the pointer.<br/>Press <b>F</b> or <b>right-click</b> to fire. Mobile: use the <b>Fire</b> button.</p>
      <div class="row" style="margin:8px 0;">
        <button id="start" class="cta cta--primary" aria-label="Play"><span class="cta__icon" aria-hidden="true">▶</span> Play</button>
        <button id="dailyBtn" class="cta cta--secondary" aria-label="Daily Run"><span class="cta__icon" aria-hidden="true">☀</span> Daily Run</button>
      </div>
      <div class="hint">Controls: Click/Tap to dash • <b>F/right-click</b> to fire • Space to restart • P to pause</div>
      <div style="margin-top:10px; opacity:.85; font-size:13px;">Name: <input id="nameInput" type="text" placeholder="Your name (for scores)" style="width:220px;" /></div>
    </div>
  </div>

  <button id="fireBtn" class="cta cta--secondary" aria-label="Fire"><span class="cta__icon" aria-hidden="true">✹</span> Fire</button>

  <div id="lbModal" class="modal">
    <div class="sheet">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Leaderboard</h2>
        <button id="lbClose" class="cta cta--secondary" style="padding:10px 14px;">Close</button>
      </div>
      <div style="margin: 8px 0;">
        <ins id="ad-modal-unit" class="adsbygoogle"
             style="display:block; width:100%; max-width:336px; margin:0 auto;"
             data-ad-client="ca-pub-3857946786580406"
             data-ad-slot="7067398117"
             data-ad-format="auto"
             data-full-width-responsive="false"></ins>
      </div>
      <div class="row" style="margin:8px 0 12px 0; align-items:center;">
        <select id="lbMode" style="pointer-events:auto; background:#101823; border:1px solid #233146; color:#e6edf3; padding:10px 12px; border-radius:10px; outline:none;">
          <option value="normal">Normal</option>
          <option value="daily">Daily (today)</option>
        </select>
        <div id="lbInfo" style="opacity:.8; font-size:13px;"></div>
      </div>
      <table id="lbTable"><thead><tr><th style="width:56px;">#</th><th>Name</th><th>Score</th><th style="text-align:right;">When</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

<script>
(() => {
  // ---------- Canvas setup ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let W=0, H=0, DPR=Math.min(window.devicePixelRatio||1, 2);

  function resize(){ 
    W=innerWidth|0; H=innerHeight|0;
    canvas.width=W*DPR; canvas.height=H*DPR;
    canvas.style.width=W+'px'; canvas.style.height=H+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    fx.width = W; fx.height = H; fxCtx.setTransform(1,0,0,1,0,0);
  }
  addEventListener('resize', resize);

  // offscreen for bloom
  const fx = document.createElement('canvas');
  const fxCtx = fx.getContext('2d');

  // small noise tile
  const noise = document.createElement('canvas');
  noise.width = noise.height = 64;
  const nctx = noise.getContext('2d');
  const id = nctx.createImageData(64,64);
  for(let i=0;i<id.data.length;i+=4){ const v = (Math.random()*255)|0; id.data[i]=id.data[i+1]=id.data[i+2]=v; id.data[i+3]=255; }
  nctx.putImageData(id,0,0);

  resize();

  // ---------- Ad handling (blocker-safe + width-capped) ----------
  function markAdsBlocked(){ document.documentElement.classList.add('ads-blocked'); }
  window.addEventListener('load', () => {
    setTimeout(() => { if(!window.adsbygoogle || !window.adsbygoogle.loaded) markAdsBlocked(); }, 1200);
  });

  const topIns = document.getElementById('ad-top-unit');
  function tryFillTopAd(){
    if(!topIns || document.documentElement.classList.contains('ads-blocked')) return true;
    const w = topIns.clientWidth;
    if(w && w > 0){ try { (window.adsbygoogle=window.adsbygoogle||[]).push({}); } catch(e) {} return true; }
    return false;
  }
  window.addEventListener('load', ()=>{
    let ok = tryFillTopAd();
    if(!ok){
      const id = setInterval(()=>{ if(tryFillTopAd()) clearInterval(id); }, 200);
      setTimeout(()=> clearInterval(id), 5000);
    }
  });

  const spacer = document.getElementById('ad-spacer');
  if('ResizeObserver' in window){
    new ResizeObserver(()=>{
      const h = document.getElementById('ad-top-wrapper').offsetHeight||72;
      spacer.style.height = h + 'px';
      document.documentElement.style.setProperty('--adH', h+'px');
    }).observe(document.getElementById('ad-top-wrapper'));
  }

  // ---------- Storage helpers ----------
  function getLS(k, fallback){ try{ const v = localStorage.getItem(k); return v===null? fallback: v; }catch{ return fallback; } }
  function setLS(k, v){ try{ localStorage.setItem(k, v); }catch{} }

  // ---------- State ----------
  const state={ running:false, paused:false, score:0, combo:0, time:0,
    best:Number(getLS('lr_best', 0)), dailyBest:Number(getLS('lr_daily', 0)),
    spawnTimer:0, spawnInterval:1.05, dailyMode:false };

  const ui={ 
    score:document.getElementById('score'), combo:document.getElementById('combo'),
    best:document.getElementById('best'), daily:document.getElementById('daily'),
    overlay:document.getElementById('overlay'),
    start:document.getElementById('start'), dailyBtn:document.getElementById('dailyBtn'),
    lbBtn:document.getElementById('lbBtn'), nameInput:document.getElementById('nameInput'),
  };
  function hydrateHUD(){ ui.score.textContent='Score: 0'; ui.combo.textContent='Combo: 0'; ui.best.textContent='Best: '+state.best; ui.daily.textContent='Daily: '+state.dailyBest; }
  hydrateHUD();

  // RNG & daily
  const todayKey=()=>new Date().toISOString().slice(0,10);
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}};
  let seededRand=Math.random; let usingSeed=false;
  function setDailySeed(){ usingSeed=true; seededRand=mulberry32(hashToInt('looprunner:'+todayKey())); }
  function rnd(a=0,b=1){ return (usingSeed?seededRand():Math.random())*(b-a)+a; }
  function rndi(a,b){ return Math.floor(rnd(a,b+1)); }
  function hashToInt(str){ let h=2166136261>>>0; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }

  // ---------- Supabase (global leaderboard) ----------
  const SUPABASE_URL = "https://zpoerliqhcywaulbthyf.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpwb2VybGlxaGN5d2F1bGJ0aHlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMDQxNjYsImV4cCI6MjA3Mzc4MDE2Nn0.7jjITj1H2AxWPnCeyzmMsNw3uAVACoYb_CV5rRoD65k";
  let sb = null;
  try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch(e) { console.warn('Supabase init failed', e); }

  async function sbSubmitScore(entry) {
    if (!sb) return false;
    try {
      const clean = (entry.name||'Player').replace(/[^\p{L}\p{N} _.-]/gu,'').slice(0,20) || 'Player';
      const { error } = await sb.from('scores').insert({
        name: clean,
        score: entry.score|0,
        mode: entry.mode,
        day: entry.day
      });
      if (error) throw error;
      return true;
    } catch (e) {
      console.warn('Remote submit failed:', e);
      return false;
    }
  }

  async function sbFetchTop(mode) {
    if (!sb) return [];
    let q = sb.from('scores')
      .select('name,score,created_at,day')
      .order('score', { ascending: false })
      .limit(10);
    if (mode === 'daily') q = q.eq('mode','daily').eq('day', todayKey());
    else q = q.eq('mode','normal');
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }

  // Audio (tiny beeps)
  let audio, master;
  function initAudio(){ if(!audio){ audio=new (window.AudioContext||window.webkitAudioContext)(); master=audio.createGain(); master.gain.value=0.08; master.connect(audio.destination); } }
  function beep(freq=440, dur=0.06){ if(!audio) return; const o=audio.createOscillator(); const g=audio.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=0.0001; g.gain.linearRampToValueAtTime(0.2, audio.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime+dur); o.connect(g); g.connect(master); o.start(); o.stop(audio.currentTime+dur+0.02); }

  // Entities
  const player={ x:W/2, y:H/2, r:12, vx:0, vy:0, maxSpeed:900, friction:9, dashing:false, dashCooldown:0, dashWindup:0, shootCooldown:0 };
  const enemies=[]; const particles=[]; const waves=[]; const trail=[]; const bullets=[];

  function addParticle(x,y,size=2,life=0.4){ const a=rnd(0,Math.PI*2); const sp=rnd(40,240); particles.push({x,y,vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life, maxLife:life, size}); }
  function addWave(x,y){ waves.push({x,y,r:0, maxR:220, a:0.5}); }

  function spawnEnemy(){ const m=24; const side=rndi(0,3); let x,y; if(side===0){x=rnd(-m,W+m); y=-m;} else if(side===1){x=W+m; y=rnd(-m,H+m);} else if(side===2){x=rnd(-m,W+m); y=H+m;} else {x=-m; y=rnd(-m,H+m);}
    const r=rnd(14,22); const speed=rnd(40,90)+Math.min(state.time*4,220); const ang=Math.atan2(player.y-y, player.x-x)+rnd(-0.5,0.5); const vx=Math.cos(ang)*speed, vy=Math.sin(ang)*speed; enemies.push({x,y,r,vx,vy,speed,ang}); }

  // Input
  let pointer={ x:W/2, y:H/2, down:false };
  function screenToWorld(e){ const rect=canvas.getBoundingClientRect(); return { x:(e.clientX-rect.left), y:(e.clientY-rect.top) }; }
  function startDashTowards(px,py){ if(player.dashCooldown>0) return; const dx=px-player.x, dy=py-player.y; const len=Math.hypot(dx,dy)||1; const ux=dx/len, uy=dy/len; player.vx=ux*player.maxSpeed; player.vy=uy*player.maxSpeed; player.dashing=true; player.dashCooldown=0.35; player.dashWindup=0.12; for(let i=0;i<10;i++) addParticle(player.x,player.y,3,0.25); addWave(player.x,player.y); beep(660,0.05); }
  canvas.addEventListener('pointerdown',(e)=>{ if(e.button===2) return; initAudio(); const p=screenToWorld(e); pointer.down=true; pointer.x=p.x; pointer.y=p.y; startDashTowards(pointer.x,pointer.y); });
  canvas.addEventListener('pointermove',(e)=>{ const p=screenToWorld(e); pointer.x=p.x; pointer.y=p.y; });
  canvas.addEventListener('pointerup',()=>{ pointer.down=false; });
  canvas.addEventListener('contextmenu', (e)=>{ e.preventDefault(); fire(); });
  addEventListener('keydown',(e)=>{ if(e.code==='Space'){ if(!state.running) startGame(); } if(e.key==='f' || e.key==='F') fire();
    const amt=80; if(e.key.startsWith('Arrow')){ let dx=0,dy=0; if(e.key==='ArrowUp') dy=-amt; else if(e.key==='ArrowDown') dy=amt; else if(e.key==='ArrowLeft') dx=-amt; else if(e.key==='ArrowRight') dx=amt; startDashTowards(player.x+dx, player.y+dy); } });

  document.getElementById('fireBtn').addEventListener('click', ()=> fire());

  // Shooting
  function fire(){
    if(player.shootCooldown>0 || !state.running) return;
    const dx = (pointer.x||player.x) - player.x;
    const dy = (pointer.y||player.y) - player.y;
    const len = Math.hypot(dx,dy) || 1;
    const speed = 900;
    const vx = dx/len * speed, vy = dy/len * speed;
    bullets.push({ x:player.x, y:player.y, vx, vy, r:3.5, life:1.4 });
    player.shootCooldown = 0.22;
    for(let i=0;i<6;i++) addParticle(player.x, player.y, rnd(1.5,2.5), rnd(0.15,0.35));
    beep(520,0.03);
  }

  // Leaderboard (local + remote)
  const lb={ modal:document.getElementById('lbModal'), close:document.getElementById('lbClose'), modeSel:document.getElementById('lbMode'), info:document.getElementById('lbInfo'), table:document.getElementById('lbTable').querySelector('tbody') };
  function loadLB(key){ try{ return JSON.parse(getLS(key,'[]')); }catch{ return []; } }
  function saveLB(key,arr){ setLS(key, JSON.stringify(arr)); }
  function submitScore(){
    const name=(ui.nameInput.value||getLS('lr_name','Player')).slice(0,20).trim()||'Player';
    setLS('lr_name',name);
    const entry={ name, score: state.score|0, when: Date.now(), mode: state.dailyMode?'daily':'normal', day: todayKey() };
    const key = state.dailyMode ? ('lr_lb_daily_'+todayKey()) : 'lr_lb_normal';
    const arr=loadLB(key); arr.push(entry); arr.sort((a,b)=>b.score-a.score); saveLB(key, arr.slice(0,20));
    if (sbSubmitScore) sbSubmitScore(entry);
  }
  function showLeaderboard(mode){ lb.modal.classList.add('show'); lb.modeSel.value = mode || (state.dailyMode?'daily':'normal'); renderLeaderboard(); maybeFillModalAd(); }
  function hideLeaderboard(){ lb.modal.classList.remove('show'); }
  async function renderLeaderboard(){
    const mode=lb.modeSel.value;
    lb.table.innerHTML='<tr><td colspan="4" style="opacity:.7;">Loading…</td></tr>';
    lb.info.textContent = mode==='daily' ? `Date: ${todayKey()} (today)` : 'Worldwide (top 10)';
    if (sbFetchTop) {
      try {
        const data = await sbFetchTop(mode);
        if (data && data.length) {
          lb.table.innerHTML='';
          data.forEach((e,i)=>{
            const when=new Date(e.created_at).toLocaleString();
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(e.name)}</td><td>${e.score}</td><td style="text-align:right;opacity:.8">${when}</td>`;
            lb.table.appendChild(tr);
          });
          return;
        }
      } catch (e) { console.warn('Remote fetch failed:', e); }
    }
    // Fallback: local
    const key = mode==='daily' ? ('lr_lb_daily_'+todayKey()) : 'lr_lb_normal';
    const arr=loadLB(key);
    lb.table.innerHTML='';
    arr.slice(0,10).forEach((e,i)=>{
      const when=new Date(e.when).toLocaleString();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(e.name)}</td><td>${e.score}</td><td style="text-align:right;opacity:.8">${when}</td>`;
      lb.table.appendChild(tr);
    });
    if(arr.length===0){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="4" style="opacity:.7;">No scores yet. Play a run!</td>'; lb.table.appendChild(tr); }
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  lb.close.addEventListener('click', hideLeaderboard);
  lb.modeSel.addEventListener('change', ()=>{ renderLeaderboard(); });
  document.getElementById('lbBtn').addEventListener('click', ()=> showLeaderboard());

  // Fill modal ad only when visible
  let modalAdFilled = false;
  function maybeFillModalAd(){
    if(modalAdFilled || document.documentElement.classList.contains('ads-blocked')) return;
    const ins = document.getElementById('ad-modal-unit');
    if(!ins) return;
    const w = ins.clientWidth;
    if(w && w>0){ try { (window.adsbygoogle=window.adsbygoogle||[]).push({}); modalAdFilled = true; } catch(e) {} }
    else { setTimeout(maybeFillModalAd, 200); }
  }

  // ---------- Visual helpers ----------
  function clamp01(t){ return Math.max(0, Math.min(1, t)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function lerpColor(c1, c2, t){ return [ Math.round(lerp(c1[0], c2[0], t)), Math.round(lerp(c1[1], c2[1], t)), Math.round(lerp(c1[2], c2[2], t)) ]; }
  const COL_BLUE=[88,166,255], COL_YELLOW=[255,210,119], COL_RED=[255,95,95];
  function speedToColor(speed){ const t = clamp01((speed-40)/270); if(t<0.5){ const u=t/0.5; const c=lerpColor(COL_BLUE, COL_YELLOW, u); return `rgb(${c[0]},${c[1]},${c[2]})`; } const u=(t-0.5)/0.5; const c=lerpColor(COL_YELLOW, COL_RED, u); return `rgb(${c[0]},${c[1]},${c[2]})`; }

  // ---------- FX layers ----------
  function drawBackground(t){
    const g = ctx.createRadialGradient(W*0.5,H*0.5,0, W*0.5,H*0.5, Math.hypot(W,H)*0.6);
    g.addColorStop(0,'#0b0f14'); g.addColorStop(1,'#05080c');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    ctx.save(); ctx.globalAlpha = 0.08; ctx.fillStyle = '#0e141c';
    const offX = (t*12)%40, offY=(t*8)%40;
    for(let x=-40+offX; x<W+40; x+=40){ ctx.fillRect(x,0,1,H); }
    for(let y=-40+offY; y<H+40; y+=40){ ctx.fillRect(0,y,W,1); }
    ctx.restore();
    ctx.save(); ctx.globalCompositeOperation = 'multiply';
    const vg = ctx.createRadialGradient(W*0.5,H*0.5, Math.min(W,H)*0.4, W*0.5,H*0.5, Math.max(W,H)*0.7);
    vg.addColorStop(0,'rgba(0,0,0,0)'); vg.addColorStop(1,'rgba(0,0,0,0.35)');
    ctx.fillStyle = vg; ctx.fillRect(0,0,W,H);
    ctx.restore();
    ctx.save(); ctx.globalAlpha = 0.035;
    for(let y=0;y<H;y+=64) for(let x=0;x<W;x+=64) ctx.drawImage(noise, x, y);
    ctx.restore();
  }

  function updateTrail(dt){
    trail.push({x:player.x, y:player.y, a:1});
    if(trail.length>24) trail.shift();
    for(const t of trail) t.a *= Math.pow(0.9, Math.max(1, 60*dt));
  }
  function renderTrail(){
    ctx.save();
    ctx.globalCompositeOperation='lighter';
    for(let i=0;i<trail.length;i++){ const t = trail[i], a = t.a*0.35; if(a<0.02) continue; ctx.globalAlpha=a; ctx.beginPath(); ctx.arc(t.x,t.y, player.r*(1+i/trail.length*0.6), 0, Math.PI*2); ctx.fillStyle='#88ffcc'; ctx.fill(); }
    ctx.restore();
  }

  function drawBug(e){ 
    ctx.save();
    ctx.translate(e.x, e.y);
    ctx.rotate(e.ang||0);
    ctx.lineJoin='round'; ctx.lineCap='round';
    const body = speedToColor(e.speed);
    ctx.fillStyle = body;
    ctx.strokeStyle = 'rgba(0,0,0,0.55)';
    ctx.lineWidth = 2.5;
    ctx.beginPath(); ctx.ellipse(0, 0, e.r*0.9, e.r*0.65, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.ellipse(e.r*0.9, 0, e.r*0.45, e.r*0.45, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(-e.r*0.55, -e.r*0.18); ctx.lineTo(-e.r*0.55, e.r*0.18); ctx.stroke();
    if(e.r>10){ const t = performance.now()*0.003; ctx.strokeStyle = '#eafff7'; ctx.lineWidth = 2.5;
      for(let i=-1;i<=1;i++){ const sway = Math.sin(t*5 + i)*2; const y = i*e.r*0.35;
        ctx.beginPath();
        ctx.moveTo(-e.r*0.6, y);   ctx.lineTo(-e.r*1.2, y-3+sway);
        ctx.moveTo(-e.r*0.2, y);   ctx.lineTo(-e.r*0.9, y+4-sway);
        ctx.moveTo( e.r*0.2, y);   ctx.lineTo( e.r*0.9, y-4+sway);
        ctx.stroke();
      }
      ctx.beginPath();
      ctx.moveTo(e.r*1.2, -e.r*0.2); ctx.quadraticCurveTo(e.r*1.6, -e.r*0.7, e.r*1.0, -e.r*0.9);
      ctx.moveTo(e.r*1.2,  e.r*0.2); ctx.quadraticCurveTo(e.r*1.6,  e.r*0.7, e.r*1.0,  e.r*0.9);
      ctx.stroke(); }
    ctx.globalCompositeOperation='lighter';
    ctx.shadowColor = body; ctx.shadowBlur=10;
    ctx.beginPath(); ctx.ellipse(0,0, e.r*0.9, e.r*0.65, 0,0,Math.PI*2); ctx.strokeStyle=body; ctx.stroke();
    ctx.restore();
  }

  function drawBullet(b){ 
    ctx.save();
    ctx.globalCompositeOperation='lighter';
    ctx.globalAlpha = 0.95;
    ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fillStyle = '#aaf6e2'; ctx.shadowColor='#aaf6e2'; ctx.shadowBlur=12; ctx.fill();
    ctx.restore();
  }

  // ---------- Game loop ----------
  function startGame(daily=false){ state.running=true; state.paused=false; state.time=0; state.score=0; state.combo=0; state.spawnTimer=0; state.spawnInterval=1.05; enemies.length=0; particles.length=0; waves.length=0; trail.length=0; bullets.length=0; player.x=W/2; player.y=H/2; player.vx=0; player.vy=0; player.dashing=false; player.dashCooldown=0; player.dashWindup=0; player.shootCooldown=0; hydrateHUD(); state.dailyMode=daily; usingSeed=false; if(daily) setDailySeed(); ui.overlay.style.display='none'; }
  function gameOver(){ 
    state.running=false; state.paused=false; 
    if(state.dailyMode){ state.dailyBest=Math.max(state.dailyBest, state.score|0); setLS('lr_daily', state.dailyBest); } 
    else { state.best=Math.max(state.best, state.score|0); setLS('lr_best', state.best); } 
    hydrateHUD(); 
    submitScore(); 
    document.querySelector('#overlay h1').textContent='Game Over'; 
    document.querySelector('#overlay p').innerHTML=`Score: <b>${state.score|0}</b> • Best: <b>${state.dailyMode?state.dailyBest:state.best}</b>`; 
    ui.overlay.style.display='block'; 
    showLeaderboard(state.dailyMode?'daily':'normal'); 
  }

  ui.start.addEventListener('click', ()=>{ initAudio(); startGame(false); });
  ui.dailyBtn.addEventListener('click', ()=>{ initAudio(); startGame(true); });
  ui.overlay.style.display='block';

  let last = performance.now();
  function loop(){
    requestAnimationFrame(loop);
    const t=performance.now(); let dt=(t-last)/1000; last=t; 
    if(!state.running){ render(); return; }
    state.time += dt; state.score += dt*10; if(((state.score|0)%10)===0) ui.score.textContent=`Score: ${state.score|0}`;
    update(dt); render(); 
  }
  function update(dt){ 
    state.spawnTimer-=dt; if(state.spawnTimer<=0){ spawnEnemy(); state.spawnTimer=state.spawnInterval; }
    if(player.dashWindup>0){ player.dashWindup-=dt; if(player.dashWindup<=0) player.dashing=false; }
    const f=Math.exp(-player.friction*dt); player.vx*=f; player.vy*=f; player.x+=player.vx*dt; player.y+=player.vy*dt; player.x=Math.max(8,Math.min(W-8,player.x)); player.y=Math.max(8,Math.min(H-8,player.y)); if(player.dashCooldown>0) player.dashCooldown-=dt; if(player.shootCooldown>0) player.shootCooldown-=dt;
    // waves
    for(let i=0;i<waves.length;i++){ const w=waves[i]; w.r += 400*dt; w.a *= Math.pow(0.5, dt*2); if(w.r>w.maxR || w.a<0.02){ waves.splice(i,1); i--; } }
    // trail
    updateTrail(dt);
    // bullets
    for(let i=0;i<bullets.length;i++){ const b=bullets[i]; b.life-=dt; b.x+=b.vx*dt; b.y+=b.vy*dt; if(b.life<=0||b.x<-40||b.x>W+40||b.y<-40||b.y>H+40){ bullets.splice(i,1); i--; continue; } }
    // enemies
    for(let i=0;i<enemies.length;i++){ const e=enemies[i]; const ang=Math.atan2(player.y-e.y, player.x-e.x); e.vx=Math.cos(ang)*e.speed; e.vy=Math.sin(ang)*e.speed; e.ang = Math.atan2(e.vy, e.vx); e.x+=e.vx*dt; e.y+=e.vy*dt;
      // bullet hits
      for(let j=0;j<bullets.length;j++){ const b=bullets[j]; const d=Math.hypot(e.x-b.x, e.y-b.y); if(d<e.r+b.r){ enemies.splice(i,1); i--; bullets.splice(j,1); j--; state.score += 25; ui.score.textContent=`Score: ${state.score|0}`; for(let k=0;k<20;k++) addParticle(e.x,e.y, rnd(2,3), rnd(0.2,0.4)); beep(700,0.03); break; } }
      if(i<0) break;
      // player collision
      const d=Math.hypot(e.x-player.x, e.y-player.y);
      if(d<e.r+player.r){ if(player.dashing){ enemies.splice(i,1); i--; state.combo+=1; const add = Math.floor(10*Math.pow(1.4, state.combo-1)); state.score += add; ui.combo.textContent=`Combo: ${state.combo}`; ui.score.textContent=`Score: ${state.score|0}`; for(let k=0;k<28;k++) addParticle(e.x,e.y, Math.random()*2+2, Math.random()*0.5+0.2); beep(880,0.04); } else { gameOver(); break; } }
      if(e.x<-140||e.x>W+140||e.y<-140||e.y>H+140){ enemies.splice(i,1); i--; }
    }
    // particles
    for(let i=0;i<particles.length;i++){ const p=particles[i]; p.life-=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vx*=0.98; p.vy*=0.98; if(p.life<=0){ particles.splice(i,1); i--; } }
  }
  function render(){
    drawBackground(state.time);
    // particles
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(const p of particles){ const a=Math.max(0, Math.min(1, p.life/p.maxLife)); ctx.globalAlpha=a*0.8; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fillStyle='#8fb3ff'; ctx.fill(); }
    ctx.restore();
    // shockwaves
    ctx.save(); ctx.globalCompositeOperation='lighter';
    for(const w of waves){ ctx.globalAlpha=w.a*0.6; ctx.beginPath(); ctx.arc(w.x,w.y,w.r,0,Math.PI*2); ctx.strokeStyle='#88ffcc'; ctx.lineWidth=2; ctx.stroke(); }
    ctx.restore();
    // trail
    renderTrail();
    // enemies
    for(const e of enemies){ drawBug(e); }
    // bullets
    for(const b of bullets){ drawBullet(b); }
    // player
    ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0
