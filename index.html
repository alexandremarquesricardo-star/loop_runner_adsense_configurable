<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loop Runner — playloop.run</title>
  <meta name="description" content="Dash, chain, and climb the leaderboard. A fast, tiny browser action game." />

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.ico">

  <!-- Consent Mode v2 (default denied) -->
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('consent','default',{
      'ad_storage':'denied','ad_user_data':'denied','ad_personalization':'denied','analytics_storage':'denied'
    });
  </script>

  <!-- AdSense (client id provided). Place ad slot markup in body where desired. -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3857946786580406" crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b0b10; --fg:#ffffff; --muted:#9aa0a6; --accent:#6cf; --card:rgba(20,20,28,.82);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--fg); overflow:hidden; }
    body{ font:14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    /* Layout: game centered, no vertical scroll */
    .page{ display:flex; flex-direction:column; height:100%; }
    header{ display:flex; align-items:center; justify-content:center; padding:8px 10px; gap:10px; }
    main{ flex:1; display:grid; place-items:center; min-height:0; }
    footer{ display:flex; justify-content:center; align-items:center; height:0; }

    /* Canvas wrapper ensures overlay fits exactly */
    #gameWrap{ position:relative; max-width:780px; width:100%; margin:0 auto; }
    #game{ display:block; width:100%; height:auto; background:#0e0e14; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.35); }

    /* Top utility UI (Restart / Share / Daily) */
    #lr-ui{ position:fixed; left:8px; right:8px; bottom:8px; display:flex; gap:8px; justify-content:center; pointer-events:auto; z-index:20; }
    #lr-ui button{ padding:.5rem .75rem; border:0; border-radius:.75rem; box-shadow:0 2px 8px rgba(0,0,0,.2); cursor:pointer; background:#1a1a22; color:#fff; }
    #dailyBanner{ margin-left:auto; font-weight:600; opacity:.85; color:var(--muted); display:flex; align-items:center; }

    /* Overlay (Pause / Game Over) */
    #overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:15; }
    #overlay[hidden]{ display:none; }
    #overlayCard{ pointer-events:auto; min-width:min(85%,520px); max-width:92%; border-radius:16px; padding:16px 18px; background:var(--card); backdrop-filter:saturate(1.2) blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.35); color:#fff; outline:none; }
    #overlayCard h2{ margin:0 0 8px 0; font-size:18px; }
    #overlayRow{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap; }
    #overlayRow button{ border:0; border-radius:12px; padding:.55rem .9rem; cursor:pointer; background:#1a1a22; color:#fff; }

    /* Ad container: fixed to top, capped size to avoid layout shift and scrolling */
    .ad-bar{ position:fixed; top:0; left:0; right:0; display:flex; justify-content:center; padding:4px 0; z-index:30; background:rgba(0,0,0,.15); backdrop-filter:blur(3px); }
    .ad-box{ max-width:728px; width:100%; max-height:90px; overflow:hidden; display:flex; justify-content:center; align-items:center; }
    .ad-box ins{ max-height:90px !important; }

    /* Prevent accidental scroll bounce on iOS */
    .noscr{ position:fixed; inset:0; overflow:hidden; }

    /* KBD styling */
    kbd{ background:#22252e; border:1px solid #2e3240; border-bottom-width:2px; padding:.1rem .35rem; border-radius:6px; font-weight:700; font-size:.9em; }
  </style>
</head>
<body class="noscr">
  <div class="page">
    <!-- Optional top ad bar (slot markup below). Safe-capped height and fixed to avoid scroll. -->
    <div class="ad-bar" aria-hidden="true">
      <div class="ad-box">
        <!-- Example responsive ad (replace data-ad-slot with your slot id) -->
        <!--
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3857946786580406"
             data-ad-slot="YOUR_SLOT_ID"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>
        -->
        <span style="opacity:.6;font-size:12px;color:#bbb;">Ad</span>
      </div>
    </div>

    <header aria-hidden="true"></header>

    <main>
      <div id="gameWrap">
        <canvas id="game" width="640" height="360" aria-label="Loop Runner"></canvas>

        <!-- Overlay (covers canvas only) -->
        <div id="overlay" hidden>
          <div id="overlayCard" role="dialog" aria-modal="true" tabindex="-1">
            <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;">
              <h2 id="ovTitle">Paused</h2>
              <button id="ovClose">✕</button>
            </div>
            <div id="ovBody" style="opacity:.95;">Press <kbd>P</kbd> or <kbd>Esc</kbd> to resume.</div>
            <div id="overlayRow">
              <button id="btnResume">▶ Resume</button>
              <button id="btnPlayAgain">↻ Play Again</button>
              <button id="btnShare">📣 Share</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer aria-hidden="true"></footer>

    <!-- Bottom quick UI controls -->
    <div id="lr-ui">
      <button id="restartBtn" aria-label="Restart">↻ Restart</button>
      <button id="shareBtn" aria-label="Share score">📣 Share</button>
      <div id="dailyBanner"></div>
    </div>
  </div>
  <script>
  // === Start function resolver with always-available fallback (robust, no warnings) ===
  (function(){
    function createFallbackEngine(){
      var canvas = document.getElementById('game');
      var ctx = canvas.getContext('2d');
      var raf = 0, running = false, paused = false, t0 = 0;
      function loop(now){
        if(!running){ return; }
        if(!paused){
          var s = (now - t0) / 1000;
          window.currentRunSeconds = s;
          // background
          ctx.fillStyle = '#0f131b';
          ctx.fillRect(0,0,canvas.width,canvas.height);
          // player dot
          var x = canvas.width/2 + Math.cos(s*1.3) * (120 + 30*Math.sin(s*0.8));
          var y = canvas.height/2 + Math.sin(s*1.1) * (60 + 20*Math.cos(s*0.7));
          ctx.beginPath();
          ctx.arc(x,y,16,0,Math.PI*2);
          ctx.fillStyle = '#66ccff';
          ctx.fill();
        }
        raf = requestAnimationFrame(loop);
      }
      return {
        start: function(){ cancelAnimationFrame(raf); running = true; paused = false; t0 = performance.now(); raf = requestAnimationFrame(loop); },
        pause: function(){ paused = true; },
        resume: function(){ paused = false; },
        stop: function(){ running = false; cancelAnimationFrame(raf); }
      };
    }

    var fallback = null;
    function getStartFn(){
      // Prefer real engine if available
      if (window.restartGame) {
        if (fallback) { try { fallback.stop(); } catch(e) {} fallback = null; }
        return window.restartGame;
      }
      if (typeof window.startGame === 'function') {
        if (fallback) { try { fallback.stop(); } catch(e) {} fallback = null; }
        return window.startGame;
      }
      // Otherwise ensure fallback exists and return it
      if (!fallback) fallback = createFallbackEngine();
      if (typeof window.pauseGame !== 'function') window.pauseGame = function(){ if (fallback) fallback.pause(); };
      if (typeof window.resumeGame !== 'function') window.resumeGame = function(){ if (fallback) fallback.resume(); };
      return function(){ fallback.start(); };
    }
    window.__getStartFn = getStartFn;

    function startDirect(){
      try { getStartFn()({ seed: Number(window.DAILY) || 0 }); } catch(e) {}
    }

    // Auto-start whatever is available on load
    window.addEventListener('load', function(){
      if (typeof window.quickRestart === 'function') { window.quickRestart(); }
      else { startDirect(); }
    });
  })();
</script>

<script>
  // Loop Runner: Daily seed + Share + Quick Restart (safe)
  (function(){
    function getTodayKeyUTC(){
      var d = new Date();
      var y = d.getUTCFullYear();
      var m = String(d.getUTCMonth() + 1).padStart(2, '0');
      var day = String(d.getUTCDate()).padStart(2, '0');
      return y + '' + m + '' + day;
    }
    var urlParams = new URLSearchParams(location.search);
    var DAILY = urlParams.get('daily') || getTodayKeyUTC();
    var IS_TODAY = DAILY === getTodayKeyUTC();
    window.DAILY = DAILY;

    var _seed = (Number(DAILY) % 2147483647) || 1;
    function rng(){ _seed = (_seed * 48271) % 2147483647; return (_seed - 1) / 2147483646; }
    window.rng = rng;

    var dailyBannerEl = document.getElementById('dailyBanner');
    if (dailyBannerEl) {
      dailyBannerEl.textContent = IS_TODAY ? ('Daily Challenge: ' + DAILY) : ('Replaying Daily: ' + DAILY);
    }

    function saveDailyBest(seconds){
      var key = 'lr_best_' + DAILY;
      var prev = Number(localStorage.getItem(key) || 0);
      if (seconds > prev) localStorage.setItem(key, String(seconds));
    }
    function getDailyBest(){ return Number(localStorage.getItem('lr_best_' + DAILY) || 0); }
    window.saveDailyBest = saveDailyBest; window.getDailyBest = getDailyBest;

    function shareScore(seconds){
      var shareUrl = new URL(location.href); shareUrl.searchParams.set('daily', DAILY);
      var text = 'I survived ' + seconds + 's in Loop Runner! #LoopRunner ' + (IS_TODAY ? ('#Daily' + DAILY) : ('(Daily ' + DAILY + ')'));
      if (navigator.share) {
        navigator.share({ title: 'Loop Runner', text: text, url: shareUrl.toString() }).catch(function(){});
      } else {
        var t = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text) + '&url=' + encodeURIComponent(shareUrl.toString());
        window.open(t, '_blank', 'noopener,noreferrer');
      }
    }
    window.shareScore = shareScore;

    function quickRestart(){
      var startFn = (typeof window.__getStartFn === 'function') ? window.__getStartFn() : (window.restartGame || window.startGame);
      if (typeof startFn === 'function') {
        try { startFn({ seed: Number(DAILY) }); } catch(e) {}
        if (typeof hideOverlay === 'function') hideOverlay();
        if (typeof window.GAME_STATE !== 'undefined') window.GAME_STATE = 'playing';
        return true;
      }
      return false;
    }
    window.quickRestart = quickRestart;

    var rb = document.getElementById('restartBtn');
    if (rb) rb.addEventListener('click', quickRestart);
    var sb = document.getElementById('shareBtn');
    if (sb) sb.addEventListener('click', function(){ var seconds = Math.round(window.currentRunSeconds || 0); shareScore(seconds); });

    window.addEventListener('keydown', function(e){
      if (e.repeat) return;
      if (e.key === 'r' || e.key === 'R' || e.code === 'Space') { e.preventDefault(); quickRestart(); }
    });
  })();
</script>

  <script>
  // Canvas Overlay: Pause + Game Over (wired to canvas)
  (function(){
    var $ = function(id){ return document.getElementById(id); };
    var overlay = $('overlay');
    var overlayCard = $('overlayCard');
    var ovTitle = $('ovTitle');
    var ovBody = $('ovBody');
    var btnResume = $('btnResume');
    var btnPlayAgain = $('btnPlayAgain');
    var btnShare = $('btnShare');
    var ovClose = $('ovClose');
    window.GAME_STATE = 'menu';
    var lastRunSeconds = 0;

    function showOverlay(opts){
      var title = opts && opts.title ? opts.title : '';
      var body = opts && opts.body ? opts.body : '';
      var mode = opts && opts.mode ? opts.mode : 'paused';
      window.GAME_STATE = mode;
      if (ovTitle) ovTitle.textContent = title;
      if (ovBody) ovBody.innerHTML = body;
      if (overlay) overlay.hidden = false;
      if (overlayCard && overlayCard.focus) setTimeout(function(){ overlayCard.focus(); }, 0);
    }
    window.showOverlay = showOverlay;

    function hideOverlay(){ if (overlay) overlay.hidden = true; }
    window.hideOverlay = hideOverlay;

    window.pauseGameUI = function(){
      if (window.GAME_STATE !== 'playing') return;
      if (typeof window.pauseGame === 'function') window.pauseGame();
      showOverlay({ title: 'Paused', body: 'Press <kbd>P</kbd> or <kbd>Esc</kbd> to resume.', mode: 'paused' });
    };
    window.resumeGameUI = function(){
      if (window.GAME_STATE !== 'paused') return;
      if (typeof window.resumeGame === 'function') window.resumeGame();
      window.GAME_STATE = 'playing'; hideOverlay();
    };

    if (btnResume) btnResume.addEventListener('click', function(){
      if (window.GAME_STATE === 'paused') window.resumeGameUI();
      else if (window.GAME_STATE === 'gameover') { if (window.quickRestart) window.quickRestart(); }
    });
    if (btnPlayAgain) btnPlayAgain.addEventListener('click', function(){ if (window.quickRestart) window.quickRestart(); });
    if (btnShare) btnShare.addEventListener('click', function(){ if (typeof window.shareScore === 'function') window.shareScore(lastRunSeconds); });
    if (ovClose) ovClose.addEventListener('click', function(){ if (window.GAME_STATE === 'paused') window.resumeGameUI(); else hideOverlay(); });

    var gameCanvas = $('game');
    if (gameCanvas) gameCanvas.addEventListener('pointerdown', function(){ if (window.GAME_STATE === 'gameover') { if (window.quickRestart) window.quickRestart(); } });

    window.addEventListener('keydown', function(e){
      if (e.repeat) return;
      if (e.key === 'p' || e.key === 'P' || e.key === 'Escape'){
        if (window.GAME_STATE === 'playing'){ e.preventDefault(); window.pauseGameUI(); }
        else if (window.GAME_STATE === 'paused'){ e.preventDefault(); window.resumeGameUI(); }
      }
    });

    window.onRunEnd = function(seconds){
      lastRunSeconds = Math.round(seconds || 0);
      if (typeof window.saveDailyBest === 'function') window.saveDailyBest(lastRunSeconds);
      showOverlay({ title: 'Game Over — ' + lastRunSeconds + 's', body: 'Nice run! Tap/click “Play Again” or press <kbd>Space</kbd>.', mode: 'gameover' });
    };
  })();
</script>

  <script>
    /* ======================================================
       No-scroll hardening for touch devices
       ====================================================== */
    function preventScroll(e){ e.preventDefault(); }
    window.addEventListener('touchmove', preventScroll, { passive:false });
    window.addEventListener('wheel', preventScroll, { passive:false });
  </script>
</body>
</html>
